#!/bin/bash

INSTDIR=${1:?usage: $0 install-dir}

if [ -d sql ]
then
  test -d build && rm -rf build
  mkdir build
  cd build
fi

#CC=gcc
#CXX=g++
CFLAGS="-O2 -ggdb -fno-omit-frame-pointer -fno-strict-aliasing -DNDEBUG -DDBUG_OFF -Wno-maybe-uninitialized $X_CFLAGS"
CXXFLAGS="$CFLAGS -felide-constructors"

CMAKE_LAYOUT_OPTS="-DINSTALL_LAYOUT=RPM -DINSTALL_SCRIPTDIR=bin -DINSTALL_MYSQLDATADIR=var -DINSTALL_SBINDIR=libexec -DINSTALL_SUPPORTFILESDIR=share -DINSTALL_SYSCONFDIR=etc -DINSTALL_SYSCONF2DIR=etc/my.cnf.d -DCMAKE_INSTALL_PREFIX=$INSTDIR -DMYSQL_DATADIR=$INSTDIR/var"

CMAKE_FEATURE_OPTS="-DWITH_READLINE=1 -DWITHOUT_OQGRAPH_STORAGE_ENGINE=1 -DWITHOUT_TOKUDB_STORAGE_ENGINE=1 -DWITHOUT_EMBEDDED_SERVER=1 -DWITHOUT_MROONGA_STORAGE_ENGINE=1 -DWITHOUT_SPIDER_STORAGE_ENGINE=1 -DWITHOUT_ROCKSDB_STORAGE_ENGINE=1"

CMAKE_BUILD_OPTS="-DCMAKE_BUILD_TYPE=RelWithDebInfo"

cmake .. $CMAKE_BUILD_OPTS $CMAKE_LAYOUT_OPTS $CMAKE_FEATURE_OPTS $X_CMAKE -DCMAKE_C_FLAGS_RELWITHDEBINFO="$CFLAGS" -DCMAKE_CXX_FLAGS_RELWITHDEBINFO="$CXXFLAGS"

make -j && make install

